#!/usr/bin/env bash
# A script for adding aero style window snapping to Linux.
# by Miles Whittaker <mjwhitta@gmail.com>
#
# --------------------------------------------------------------------
# The MIT License (MIT)
#
# Copyright (c) 2017 Miles Whittaker
#
# Permission is hereby granted, free of charge, to any person
# obtaining a copy of this software and associated documentation files
# (the "Software"), to deal in the Software without restriction,
# including without limitation the rights to use, copy, modify, merge,
# publish, distribute, sublicense, and/or sell copies of the Software,
# and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
# BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
# ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
# --------------------------------------------------------------------

usage() {
    echo "Usage: ${0/*\//} [OPTIONS] [width] [height]"
    echo
    echo "Simple window management tool"
    echo
    echo "Options:"
    echo "    -b, --bottom             Snap active window to bottom"
    echo "                             bottom of screen"
    echo "    --bottom-left            Snap active window to"
    echo "                             bottom-left of screen"
    echo "    --bottom-right           Snap active window to"
    echo "                             bottom-right of screen"
    echo "    -c, --center             Snap active window to center"
    echo "                             of screen"
    echo "    -f, --frame=FRAME        Specify frame size (default:"
    echo "                             $frame)"
    echo "    -h, --help               Display this help message"
    echo "    -l, --left               Snap active window to left of"
    echo "                             screen"
    echo "    -m, --max                Maximize window"
    echo "    -n, --min                Minimize widow"
    echo "    -o, --offset=OFFSET      Specify offset from top of"
    echo "                             screen (default: $offset)"
    echo "    -p, --padding=PADDING    Specify padding around frame"
    echo "                             (default: $padding)"
    echo "    -r, --right              Snap active window to right of"
    echo "                             screen"
    echo "    -t, --top                Snap active window to top of"
    echo "                             screen"
    echo "    --top-left               Snap active window to top-left"
    echo "                             of screen"
    echo "    --top-right              Snap active window to"
    echo "                             top-right of screen"
    echo
    exit $1
}

declare -a args
frame=20
offset=0
padding=0
snap_hist="/tmp/snap.hist"

while [[ $# -gt 0 ]]; do
    case "$1" in
        "--") shift && args+=("$@") && break ;;
        "-b"|"--bottom") snap_option="bottom" ;;
        "--bottom-left") snap_option="bottom-left" ;;
        "--bottom-right") snap_option="bottom-right" ;;
        "-c"|"--center") snap_option="center" ;;
        "-f"|"--frame"*)
            case "$1" in
                "--"*"="*) arg="${1#*=}"; [[ -n $arg ]] || usage 1 ;;
                *) shift; [[ $# -gt 0 ]] || usage 1; arg="$1" ;;
            esac
            frame="$arg"
            ;;
        "-h"|"--help") usage 0 ;;
        "-l"|"--left") snap_option="left" ;;
        "-m"|"--max") snap_option="max" ;;
        "-n"|"--min") snap_option="min" ;;
        "-o"|"--offset"*)
            case "$1" in
                "--"*"="*) arg="${1#*=}"; [[ -n $arg ]] || usage 1 ;;
                *) shift; [[ $# -gt 0 ]] || usage 1; arg="$1" ;;
            esac
            offset="$arg"
            ;;
        "-p"|"--padding"*)
            case "$1" in
                "--"*"="*) arg="${1#*=}"; [[ -n $arg ]] || usage 1 ;;
                *) shift; [[ $# -gt 0 ]] || usage 1; arg="$1" ;;
            esac
            padding="$arg"
            ;;
        "-r"|"--right") snap_option="right" ;;
        "-t"|"--top") snap_option="top" ;;
        "--top-left") snap_option="top-left" ;;
        "--top-right") snap_option="top-right" ;;
        *) args+=("$1") ;;
    esac
    shift
done
[[ -z ${args[@]} ]] || set -- "${args[@]}"

[[ $# -eq 0 ]] || [[ $# -eq 2 ]] || usage 2
[[ -n $(command -v wmctrl) ]] || usage 3
[[ -n $(command -v xdotool) ]] || usage 4
[[ -n $(command -v xrandr) ]] || usage 5

geometry="$(
    xrandr | perl -lne '/current ([^,]+),/ && print $1 =~ s/\s+//rg'
)"
[[ -z $geometry ]] && echo "Can't figure out geometry!" && exit 6
width="${geometry/x*/}"
height="${geometry/*x/}"

[[ $# -eq 2 ]] && width="$1" && height="$2"

let "height = $height - $offset"
let "hw = $width / 2"
let "hhw = $width / 4"
let "hh = $height / 2"
let "hhh = $height / 4"
let "g = 0"

[[ $padding -eq 0 ]] || padded="true"

# Wait for lock file to go away
for i in $(seq 1 20); do
    [[ -f ${snap_hist}.lock ]] || break
    sleep 0.1
done

if [[ -f ${snap_hist}.lock ]]; then
    echo "Lock file may need to be manually deleted"
    exit 7
fi

# Lock
touch ${snap_hist}.lock

# Get unique ID
wid="$(xdotool getactivewindow)"
wpid="$(xdotool getwindowpid $wid)"

# Check history file for entry and see if matches current location
previous="$(
    perl -lne '/'$wid'-'$wpid' ('$snap_option')/ && print $1' \
    $snap_hist 2>/dev/null
)"

# Remove old entry and remove any maximized attributes
cat $snap_hist 2>/dev/null | \grep -v "$wid-$wpid" >$snap_hist
wmctrl -r :ACTIVE: -b remove,maximized_vert,maximized_horz

if [[ -z $previous ]]; then
    # Calculate snap values
    case "$snap_option" in
        "bottom")
            let "x = $padding"
            let "y = $hh + ($padding / 2) + $offset"
            let "w = $width - (2 * $padding)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
        "bottom-left")
            let "x = $padding"
            let "y = $hh + ($padding / 2) + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
        "bottom-right")
            let "x = $hw + ($padding / 2)"
            let "y = $hh + ($padding /  2) + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
        "center")
            let "x = $hhw + ($padding / 2)"
            let "y = $padding + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $height - (2 * $padding) - $frame"
            ;;
        "left")
            let "x = $padding"
            let "y = $padding + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $height - (2 * $padding) - $frame"
            ;;
        "max")
            let "x = $padding"
            let "y = $padding + $offset"
            let "w = $width - (2 * $padding)"
            let "h = $height - (2 * $padding) - $frame"
            ;;
        "min")
            let "x = $hhw + ($padding / 2)"
            let "y = $hhh + ($padding / 2) + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
        "right")
            let "x = $hw + ($padding / 2)"
            let "y = $padding + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $height - (2 * $padding) - $frame"
            ;;
        "top")
            let "x = $padding"
            let "y = $padding + $offset"
            let "w = $width - (2 * $padding)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
        "top-left")
            let "x = $padding"
            let "y = $padding + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
        "top-right")
            let "x = $hw + ($padding / 2)"
            let "y = $padding + $offset"
            let "w = $hw - (3 * $padding / 2)"
            let "h = $hh - (3 * $padding / 2) - $frame"
            ;;
    esac

    # Snap
    wmctrl -r :ACTIVE: -e $g,$x,$y,$w,$h

    # Set any needed maximized attributes
    case "$snap_option" in
        "bottom")
            if [[ -z $padded ]]; then
                wmctrl -r :ACTIVE: -b add,maximized_horz
            fi
            ;;
        "bottom-left") ;;
        "bottom-right") ;;
        "center")
            if [[ -z $padded ]]; then
                wmctrl -r :ACTIVE: -b add,maximized_vert
            fi
            ;;
        "left")
            if [[ -z $padded ]]; then
                wmctrl -r :ACTIVE: -b add,maximized_vert
            fi
            ;;
        "max")
            if [[ -z $padded ]]; then
                wmctrl -r :ACTIVE: -b \
                    add,maximized_vert,maximized_horz
            fi
            ;;
        "min") wmctrl -r :ACTIVE: -b add,hidden ;;
        "right")
            if [[ -z $padded ]]; then
                wmctrl -r :ACTIVE: -b add,maximized_vert
            fi
            ;;
        "top")
            if [[ -z $padded ]]; then
                wmctrl -r :ACTIVE: -b add,maximized_horz
            fi
            ;;
        "top-left") ;;
        "top-right") ;;
    esac

    # Create new entry
    if [[ $snap_option != "min" ]]; then
        echo "$wid-$wpid $snap_option" >>$snap_hist
    fi
else
    # Calculate snap values
    let "x = $hhw + ($padding / 2)"
    let "y = $hhh + ($padding / 2) + $offset"
    let "w = $hw - (3 * $padding / 2)"
    let "h = $hh - (3 * $padding / 2) - $frame"

    # Snap
    wmctrl -r :ACTIVE: -e $g,$x,$y,$w,$h

    # Remove history file if empty
    [[ -n $(cat $snap_hist 2>/dev/null) ]] || rm -f $snap_hist
fi

# Unlock
rm -f ${snap_hist}.lock
